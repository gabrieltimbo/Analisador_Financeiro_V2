# -*- coding: utf-8 -*-
"""Analisador Financeiro V2

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KSwhMO_2MysN-c6GuPZgl3tWv3ysM63s
"""

# -*- coding: utf-8 -*-
"""Analisador Financeiro V6"""

import streamlit as st
import matplotlib.pyplot as plt
from matplotlib.backends.backend_pdf import PdfPages
import io
import datetime

# ==============================
# 0ï¸âƒ£ Login + Idioma + Nome do Analista
# ==============================
st.title("ğŸ”’ Analisador Financeiro de Clientes")
senha = st.text_input("Digite a senha para acessar o app", type="password")
if senha != "minhaSenhaSegura":
    st.warning("Senha incorreta! Acesso negado.")
    st.stop()

# SeleÃ§Ã£o de idioma
idioma = st.radio("Idioma / Language", ("ğŸ‡§ğŸ‡· PortuguÃªs", "ğŸ‡ºğŸ‡¸ English"))

# FunÃ§Ã£o para textos de acordo com idioma
def text(key):
    textos = {
        "pt": {
            "nome_analista": "Nome do Analista",
            "informe_analista": "Por favor, informe o nome do analista para prosseguir.",
            "informacoes_cliente": "ğŸ“Œ InformaÃ§Ãµes do Cliente",
            "perfil_credito": "PERFIL DE CRÃ‰DITO",
            "risco_credito_externo": "Risco de CrÃ©dito Externo",
            "calcular": "ğŸ’¡ Calcular AnÃ¡lise Financeira",
            "exportar_pdf": "ğŸ“„ Exportar PDF",
            "recomendacoes": "ğŸ“ RecomendaÃ§Ãµes",
        },
        "en": {
            "nome_analista": "Analyst Name",
            "informe_analista": "Please provide the analyst's name to proceed.",
            "informacoes_cliente": "ğŸ“Œ Client Information",
            "perfil_credito": "CREDIT PROFILE",
            "risco_credito_externo": "External Credit Risk",
            "calcular": "ğŸ’¡ Calculate Financial Analysis",
            "exportar_pdf": "ğŸ“„ Export PDF",
            "recomendacoes": "ğŸ“ Recommendations",
        }
    }
    return textos["pt" if idioma.startswith("ğŸ‡§ğŸ‡·") else "en"][key]

# Nome do Analista
nome_analista = st.text_input(text("nome_analista"))
if not nome_analista:
    st.warning(text("informe_analista"))
    st.stop()

# ==============================
# 1ï¸âƒ£ FunÃ§Ã£o de anÃ¡lise financeira
# ==============================
def analise_financeira(contas_receber, receita, ativo_circ, estoque, ativo_total,
                       passivo_circ, passivo_total, dividas, patrimonio, lucro, ebitda,
                       caixa, prazo_faturamento, perfil="NORMAL", risco_credito_externo="MÃ©dio Risco"):

    indicadores = {}

    # --- Liquidez ---
    indicadores['Liquidez Corrente'] = round((ativo_circ / passivo_circ) if passivo_circ else 0, 2)
    indicadores['Liquidez Seca'] = round(((ativo_circ - estoque) / passivo_circ) if passivo_circ else 0, 2)

    # --- Estrutura de Capital ---
    indicadores['Endividamento Total (%)'] = round((passivo_total / ativo_total) * 100 if ativo_total else 0, 2)
    indicadores['ComposiÃ§Ã£o do Endividamento (%)'] = round((passivo_circ / passivo_total) * 100 if passivo_total else 0, 2)
    indicadores['Alavancagem (DÃ­vida / PL)'] = round((dividas / patrimonio) if patrimonio else 0, 2)

    # --- Rentabilidade ---
    indicadores['Margem LÃ­quida (%)'] = round((lucro / receita) * 100 if receita else 0, 2)
    indicadores['EBITDA / Receita (%)'] = round((ebitda / receita) * 100 if receita else 0, 2)
    indicadores['ROE (%)'] = round((lucro / patrimonio) * 100 if patrimonio else 0, 2)

    # --- Score para Rating ---
    score = 0
    if indicadores['Endividamento Total (%)'] < 50: score += 2
    if indicadores['Liquidez Corrente'] > 1.2: score += 2
    if indicadores['Liquidez Seca'] > 1: score += 1
    if indicadores['Margem LÃ­quida (%)'] > 10: score += 2
    if indicadores['EBITDA / Receita (%)'] > 15: score += 1
    if indicadores['ROE (%)'] > 10: score += 1

    # --- Ajuste pelo Risco de CrÃ©dito Externo ---
    ajuste_externo = {
        "Muito Baixo Risco": 2,
        "Baixo Risco": 1,
        "MÃ©dio Risco": 0,
        "Alto Risco": -1,
        "Muito Alto Risco": -2,
        "Very Low Risk": 2,
        "Low Risk": 1,
        "Medium Risk": 0,
        "High Risk": -1,
        "Very High Risk": -2
    }
    score += ajuste_externo.get(risco_credito_externo, 0)

    # Rating final
    if score >= 9: rating = "A"
    elif score >= 7: rating = "B"
    elif score >= 5: rating = "C"
    elif score >= 3: rating = "D"
    else: rating = "E"
    indicadores['Rating do Cliente'] = rating

    # --- Limite de crÃ©dito ---
    fatura_mensal = (contas_receber / prazo_faturamento) * 30  
    fator_prazo = 1 + min(prazo_faturamento / 60, 0.2)
    fator_rating = {"A":1.2, "B":1.0, "C":0.8, "D":0.5, "E":0.3}.get(rating,1)
    fator_margem = 1 + (min(indicadores['Margem LÃ­quida (%)'], 15)/100)
    fator_caixa = 0.3 + min(caixa / (dividas + 1e-6), 0.5)

    comp_passivo_circ = indicadores['ComposiÃ§Ã£o do Endividamento (%)'] / 100
    if comp_passivo_circ > 0.6: fator_passivo = 0.5
    elif comp_passivo_circ > 0.4: fator_passivo = 0.7
    else: fator_passivo = 1

    if indicadores['Alavancagem (DÃ­vida / PL)'] > 5: fator_alavancagem = 0.5
    elif indicadores['Alavancagem (DÃ­vida / PL)'] > 3: fator_alavancagem = 0.7
    else: fator_alavancagem = 1

    limite_credito_ajustado = fatura_mensal * fator_prazo * fator_rating * fator_margem * fator_caixa * fator_passivo * fator_alavancagem

    if perfil.upper() == "PESSIMISTA": limite_credito_ajustado *= 0.7
    if rating == "E": limite_credito_ajustado = 1

    indicadores['Limite de CrÃ©dito Sugerido (R$)'] = round(limite_credito_ajustado, 2)
    return indicadores

def recomendacoes(rating, idioma="pt"):
    rec_pt = {
        "A": "Cliente saudÃ¡vel para crÃ©dito. Monitorar apenas fluxos futuros.",
        "B": "Cliente com bom histÃ³rico. Revisar condiÃ§Ãµes de pagamento periÃ³dicas.",
        "C": "Risco moderado. Avaliar garantias e limites de crÃ©dito.",
        "D": "Risco elevado. Exigir garantias adicionais e reduzir limites.",
        "E": "Alto risco. Evitar concessÃ£o de crÃ©dito sem garantias sÃ³lidas."
    }
    rec_en = {
        "A": "Healthy client for credit. Monitor only future cash flows.",
        "B": "Client with good history. Review payment terms periodically.",
        "C": "Moderate risk. Evaluate guarantees and credit limits.",
        "D": "High risk. Require additional guarantees and reduce limits.",
        "E": "Very high risk. Avoid granting credit without solid guarantees."
    }
    return rec_pt[rating] if idioma=="pt" else rec_en[rating]

# ==============================
# 2ï¸âƒ£ Layout Interativo
# ==============================
st.subheader(text("informacoes_cliente"))
col1, col2 = st.columns(2)

with col1:
    nome_cliente = st.text_input("Nome do Cliente" if idioma=="pt" else "Client Name")
    data_analise = st.date_input("Data da AnÃ¡lise" if idioma=="pt" else "Analysis Date", datetime.date.today())
    contas_receber = st.number_input("Contas a Receber (R$)" if idioma=="pt" else "Accounts Receivable (R$)", min_value=0.0)
    ativo_circ = st.number_input("Ativo Circulante (R$)" if idioma=="pt" else "Current Assets (R$)", min_value=0.0)
    estoque = st.number_input("Estoques (R$)" if idioma=="pt" else "Inventory (R$)", min_value=0.0)
    ativo_total = st.number_input("Ativo Total (R$)" if idioma=="pt" else "Total Assets (R$)", min_value=0.0)
    receita = st.number_input("Receita LÃ­quida (R$)" if idioma=="pt" else "Net Revenue (R$)", min_value=0.0)
    ebitda = st.number_input("EBITDA (R$)", min_value=0.0)
    caixa = st.number_input("Caixa DisponÃ­vel (R$)" if idioma=="pt" else "Available Cash (R$)", min_value=0.0)
    observacao = st.text_area("ObservaÃ§Ã£o (ex.: este relatÃ³rio Ã© apenas uma sugestÃ£o)" if idioma=="pt" else "Observation (e.g.: this report is only a suggestion)", 
                              value="Este relatÃ³rio Ã© apenas uma sugestÃ£o e nÃ£o deve ser usado como decisÃ£o final." if idioma=="pt" else "This report is only a suggestion and should not be used as final decision.")

with col2:
    passivo_circ = st.number_input("Passivo Circulante (R$)" if idioma=="pt" else "Current Liabilities (R$)", min_value=0.0)
    passivo_total = st.number_input("Passivo Total (R$)" if idioma=="pt" else "Total Liabilities (R$)", min_value=0.0)
    dividas = st.number_input("DÃ­vidas Totais (R$)" if idioma=="pt" else "Total Debts (R$)", min_value=0.0)
    patrimonio = st.number_input("PatrimÃ´nio LÃ­quido (R$)" if idioma=="pt" else "Equity (R$)", min_value=0.0)
    lucro = st.number_input("Lucro LÃ­quido (R$)" if idioma=="pt" else "Net Profit (R$)")
    prazo_faturamento = st.number_input("Prazo mÃ©dio de faturamento (dias)" if idioma=="pt" else "Average Billing Term (days)", min_value=1)
    risco_credito_externo = st.selectbox(text("risco_credito_externo"), 
                                         ["Muito Baixo Risco", "Baixo Risco", "MÃ©dio Risco", "Alto Risco", "Muito Alto Risco"] if idioma=="pt" else ["Very Low Risk", "Low Risk", "Medium Risk", "High Risk", "Very High Risk"])

perfil = st.selectbox(text("perfil_credito"), ["NORMAL", "PESSIMISTA"] if idioma=="pt" else ["NORMAL", "PESSIMISTIC"])

# ==============================
# 3ï¸âƒ£ BotÃ£o de cÃ¡lculo
# ==============================
if st.button(text("calcular")):
    resultado = analise_financeira(contas_receber, receita, ativo_circ, estoque, ativo_total,
                                   passivo_circ, passivo_total, dividas, patrimonio, lucro, ebitda,
                                   caixa, prazo_faturamento, perfil=perfil, 
                                   risco_credito_externo=risco_credito_externo)

    # ----- KPIs com emojis -----
    st.subheader("ğŸ“Š KPIs Financeiros")
    kpis = {
        "Liquidez Corrente": ("ğŸŸ¢" if resultado['Liquidez Corrente']>1.2 else "ğŸŸ ", resultado['Liquidez Corrente']),
        "Liquidez Seca": ("ğŸŸ¢" if resultado['Liquidez Seca']>1 else "ğŸŸ ", resultado['Liquidez Seca']),
        "Endividamento Total (%)": ("ğŸŸ¢" if resultado['Endividamento Total (%)']<50 else "ğŸ”´", resultado['Endividamento Total (%)']),
        "ComposiÃ§Ã£o do Endividamento (%)": ("ğŸŸ¢" if resultado['ComposiÃ§Ã£o do Endividamento (%)']<50 else "ğŸŸ ", resultado['ComposiÃ§Ã£o do Endividamento (%)']),
        "Alavancagem (DÃ­vida / PL)": ("ğŸŸ " if resultado['Alavancagem (DÃ­vida / PL)']>5 else "ğŸŸ¢", resultado['Alavancagem (DÃ­vida / PL)']),
        "Margem LÃ­quida (%)": ("ğŸŸ¢" if resultado['Margem LÃ­quida (%)']>10 else "ğŸŸ ", resultado['Margem LÃ­quida (%)']),
        "EBITDA / Receita (%)": ("ğŸŸ¢" if resultado['EBITDA / Receita (%)']>15 else "ğŸŸ ", resultado['EBITDA / Receita (%)']),
        "ROE (%)": ("ğŸŸ¢" if resultado['ROE (%)']>10 else "ğŸŸ ", resultado['ROE (%)']),
        "Limite de CrÃ©dito Sugerido (R$)": ("ğŸŸ¢", resultado['Limite de CrÃ©dito Sugerido (R$)'])
    }

    for k, (emoji, valor) in kpis.items():
        if "R$" in k:
            st.metric(label=f"{emoji} {k}", value=f"R$ {valor:,.2f}")
        else:
            st.metric(label=f"{emoji} {k}", value=f"{valor:.2f}")

    # Rating
    rating = resultado['Rating do Cliente']
    cores_rating = {"A":"green","B":"blue","C":"yellow","D":"orange","E":"red"}
    st.markdown(f"**â­ Rating do Cliente:** <span style='color:{cores_rating[rating]}; font-size:20px'>{rating}</span>", unsafe_allow_html=True)

    # RecomendaÃ§Ãµes
    st.subheader(text("recomendacoes"))
    st.info(recomendacoes(rating, idioma="pt" if idioma.startswith("ğŸ‡§ğŸ‡·") else "en"))

    # ----- PDF -----
    st.subheader(text("exportar_pdf"))
    pdf_buffer = io.BytesIO()
    with PdfPages(pdf_buffer) as pdf:
        plt.figure(figsize=(8,11))
        plt.axis('off')
        texto = f"RelatÃ³rio Financeiro do Cliente\n\n"
        texto += f"Analista: {nome_analista}\nCliente: {nome_cliente}\nData da AnÃ¡lise: {data_analise}\n"
        texto += f"Risco de CrÃ©dito Externo: {risco_credito_externo}\nObservaÃ§Ã£o: {observacao}\n\n"
        texto += f"=== Inputs Registrados ===\n"
        texto += f"Contas a Receber: R$ {contas_receber:,.2f}\nAtivo Circulante: R$ {ativo_circ:,.2f}\nEstoques: R$ {estoque:,.2f}\nAtivo Total: R$ {ativo_total:,.2f}\n"
        texto += f"Receita LÃ­quida: R$ {receita:,.2f}\nEBITDA: R$ {ebitda:,.2f}\nCaixa: R$ {caixa:,.2f}\n"
        texto += f"Passivo Circulante: R$ {passivo_circ:,.2f}\nPassivo Total: R$ {passivo_total:,.2f}\nDÃ­vidas Totais: R$ {dividas:,.2f}\nPatrimÃ´nio LÃ­quido: R$ {patrimonio:,.2f}\nLucro LÃ­quido: R$ {lucro:,.2f}\n"
        texto += f"Prazo mÃ©dio de faturamento: {prazo_faturamento} dias\nPerfil de CrÃ©dito: {perfil}\n\n"
        texto += f"=== Indicadores Calculados ===\n"
        for k, v in resultado.items():
            texto += f"{k}: {v}\n"
        plt.text(0, 1, texto, ha='left', va='top', fontsize=10, wrap=True)
        pdf.savefig()
        plt.close()
    pdf_buffer.seek(0)

    st.download_button(
        label="ğŸ“¥ Baixar PDF" if idioma=="pt" else "ğŸ“¥ Download PDF",
        data=pdf_buffer,
        file_name=f"Relatorio_{nome_cliente}.pdf",
        mime="application/pdf"
    )
